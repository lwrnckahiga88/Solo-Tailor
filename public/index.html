<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoloTailor AI - Professional 3D Footwear Customization</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/WebGL.js"></script>
    <style>
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --secondary: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #94a3b8;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            color: white;
        }

        header h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Scanning Section */
        .scan-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .scan-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        #camera-feed {
            width: 100%;
            border-radius: 1rem;
            display: block;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .foot-outline {
            width: 60%;
            height: 70%;
            border: 3px dashed var(--primary);
            border-radius: 20% 20% 50% 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .scan-instructions {
            text-align: center;
            margin: 1.5rem 0;
        }

        /* Customization Section */
        .customization-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .customizer-container {
            display: flex;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .customizer-container {
                flex-direction: column;
            }
        }

        .visualization-panel {
            flex: 2;
            position: relative;
        }

        #shoe-canvas {
            width: 100%;
            height: 500px;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 1rem;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .customization-panel {
            flex: 1;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 0.75rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.1);
        }

        /* Final Product Section */
        .final-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .final-view-container {
            display: flex;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .final-view-container {
                flex-direction: column;
            }
        }

        #final-shoe-canvas {
            flex: 1;
            height: 500px;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 1rem;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.1);
        }

        .final-details {
            flex: 1;
        }

        /* Common styles */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            box-shadow: 0 4px 15px rgba(109, 40, 217, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(109, 40, 217, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }

        /* Loading states */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 2rem auto;
            border: 4px solid rgba(109, 40, 217, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Model Controls */
        .model-controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            z-index: 10;
            display: flex;
            gap: 0.5rem;
        }

        .model-controls button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .model-controls button:hover {
            transform: scale(1.1);
            background: white;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--dark);
            text-align: center;
        }

        .api-status {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .api-status.connected {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .api-status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .error-screen {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            max-width: 600px;
            margin: 2rem auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>SoloTailor AI</h1>
            <p>Professional 3D Footwear Customization with Advanced Technology</p>
        </header>

        <!-- Scanning Section -->
        <section class="scan-section" id="scan-section">
            <h2 class="section-title">1. 3D Foot Scanning</h2>
            <div id="api-status" class="api-status">
                Connecting to scanning system...
            </div>
            <div class="scan-container">
                <video id="camera-feed" autoplay playsinline></video>
                <div class="scan-overlay">
                    <div class="foot-outline"></div>
                </div>
            </div>
            <div class="scan-instructions">
                <p>Position your foot within the outline and hold still for 3D scanning</p>
                <button id="start-scan" class="btn btn-primary">Start 3D Scan</button>
            </div>
            
            <div id="scan-results" class="hidden">
                <div class="spinner"></div>
                <p style="text-align: center;">Processing 3D foot scan...</p>
            </div>
        </section>

        <!-- Customization Section -->
        <section class="customization-section" id="customization-section">
            <h2 class="section-title">2. Design Your Custom Shoe</h2>
            <div class="customizer-container">
                <div class="visualization-panel">
                    <canvas id="shoe-canvas"></canvas>
                    <div class="model-controls">
                        <button id="rotate-left" title="Rotate Left">↺</button>
                        <button id="rotate-right" title="Rotate Right">↻</button>
                        <button id="reset-view" title="Reset View">⌂</button>
                    </div>
                </div>
                
                <div class="customization-panel">
                    <div class="form-group">
                        <label for="shoe-style">Shoe Style</label>
                        <select id="shoe-style" class="form-control">
                            <option value="sneaker">Athletic Sneaker</option>
                            <option value="runner">Performance Runner</option>
                            <option value="dress">Dress Shoe</option>
                            <option value="boot">Casual Boot</option>
                            <option value="loafer">Loafer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-color">Primary Color</label>
                        <input type="color" id="shoe-color" value="#2563eb" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="accent-color">Accent Color</label>
                        <input type="color" id="accent-color" value="#ffffff" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-material">Material</label>
                        <select id="shoe-material" class="form-control">
                            <option value="leather">Premium Leather</option>
                            <option value="knit">Breathable Knit</option>
                            <option value="mesh">Performance Mesh</option>
                            <option value="suede">Soft Suede</option>
                            <option value="canvas">Durable Canvas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="sole-type">Sole Type</label>
                        <select id="sole-type" class="form-control">
                            <option value="standard">Standard</option>
                            <option value="cushioned">Extra Cushioned</option>
                            <option value="performance">Performance</option>
                            <option value="dress">Dress Sole</option>
                        </select>
                    </div>
                    
                    <button id="view-final" class="btn btn-primary">View Final Design</button>
                </div>
            </div>
        </section>

        <!-- Final Product Section -->
        <section class="final-section" id="final-section">
            <h2 class="section-title">3. Your Custom Shoe</h2>
            <div class="final-view-container">
                <canvas id="final-shoe-canvas"></canvas>
                <div class="final-details">
                    <h3>Design Specifications</h3>
                    <div id="design-specs" style="margin-bottom: 1.5rem;"></div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Estimated Price: $299</strong>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Delivery: 2-3 weeks</strong>
                    </div>
                    <button id="place-order" class="btn btn-primary">Place Order</button>
                    <button id="back-to-edit" class="btn btn-secondary">Edit Design</button>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global variables
        let mediaStream;
        let scene, camera, renderer, shoeModel;
        let finalScene, finalCamera, finalRenderer;
        let footMeasurements = null;
        let currentRotation = 0;
        let animationId;
        const rotationSpeed = 0.02;
        
        // 3D Look API Configuration (simulated)
        const THREELOOK_CONFIG = {
            apiKey: 'demo_key',
            apiUrl: 'https://api.demo.me/v1',
            endpoints: {
                scan: '/scan/foot',
                measurements: '/measurements',
                model: '/model/generate'
            }
        };

        // Check WebGL support before initialization
        if (!WEBGL.isWebGLAvailable()) {
            document.body.innerHTML = `
                <div class="error-screen">
                    <h2>WebGL Not Supported</h2>
                    <p>${WEBGL.getWebGLErrorMessage()}</p>
                    <p>Please try with a different browser or device that supports WebGL.</p>
                    <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
                </div>
            `;
            throw new Error('WebGL not supported');
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initialize3DLookAPI();
                initCamera();
                setupEventListeners();
            } catch (error) {
                console.error("Initialization error:", error);
                showErrorScreen("Initialization failed", error.message);
            }
        });

        // Show error screen
        function showErrorScreen(title, message) {
            document.body.innerHTML = `
                <div class="error-screen">
                    <h2>${title}</h2>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="location.reload()">Reload Application</button>
                </div>
            `;
        }

        // Initialize API connection
        async function initialize3DLookAPI() {
            const statusElement = document.getElementById('api-status');
            
            try {
                // Simulate API connection
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                statusElement.className = 'api-status connected';
                statusElement.textContent = '✅ Scanning System Ready';
            } catch (error) {
                statusElement.className = 'api-status error';
                statusElement.textContent = '⚠️ Scanning System Unavailable';
                console.error("API connection error:", error);
            }
        }

        // Initialize camera for scanning
        async function initCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera API not available');
                }

                mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                }).catch(err => {
                    console.error("Camera access error:", err);
                    throw err;
                });
                
                const videoElement = document.getElementById('camera-feed');
                if (!videoElement) {
                    throw new Error('Camera feed element not found');
                }
                
                videoElement.srcObject = mediaStream;
                return true;
            } catch (err) {
                console.error("Camera initialization failed:", err);
                document.querySelector('.scan-instructions').innerHTML = `
                    <div class="api-status error">
                        Camera Error: ${err.message || 'Camera access not available'}
                    </div>
                    <p>Please enable camera permissions or continue with demo mode:</p>
                    <button class="btn btn-primary" onclick="startDemoScan()">Continue with Demo</button>
                `;
                return false;
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            try {
                document.getElementById('start-scan').addEventListener('click', startScan);
                document.getElementById('view-final').addEventListener('click', showFinalSection);
                document.getElementById('back-to-edit').addEventListener('click', showCustomizationSection);
                document.getElementById('place-order').addEventListener('click', placeOrder);
                
                // Customization controls
                document.getElementById('shoe-style').addEventListener('change', updateShoeModel);
                document.getElementById('shoe-color').addEventListener('change', updateShoeColor);
                document.getElementById('accent-color').addEventListener('change', updateShoeColor);
                document.getElementById('shoe-material').addEventListener('change', updateShoeModel);
                document.getElementById('sole-type').addEventListener('change', updateShoeModel);
            } catch (error) {
                console.error("Event listener setup failed:", error);
                showErrorScreen("UI Error", "Failed to set up controls");
            }
        }

        // Start scanning process
        async function startScan() {
            const scanButton = document.getElementById('start-scan');
            const scanResults = document.getElementById('scan-results');
            
            try {
                scanButton.disabled = true;
                scanButton.textContent = 'Scanning...';
                scanResults.classList.remove('hidden');
                
                // Check camera status
                if (!mediaStream) {
                    const cameraReady = await initCamera();
                    if (!cameraReady) {
                        throw new Error('Camera not available');
                    }
                }
                
                // Simulate scanning process
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Generate demo measurements
                const measurements = {
                    length: (24 + Math.random() * 4).toFixed(1),
                    width: (9 + Math.random() * 2).toFixed(1),
                    height: (6 + Math.random() * 1).toFixed(1),
                    archHeight: (2.5 + Math.random()).toFixed(1),
                    footType: ['Flat', 'Normal', 'High'][Math.floor(Math.random() * 3)]
                };
                
                footMeasurements = measurements;
                
                scanResults.innerHTML = `
                    <div style="text-align: center; color: var(--secondary);">
                        <h3>✅ Scan Complete!</h3>
                        <p>Foot measurements captured successfully</p>
                        <div style="margin-top: 1rem;">
                            <strong>Length:</strong> ${measurements.length}cm<br>
                            <strong>Width:</strong> ${measurements.width}cm<br>
                            <strong>Height:</strong> ${measurements.height}cm<br>
                            <strong>Arch Height:</strong> ${measurements.archHeight}cm<br>
                            <strong>Foot Type:</strong> ${measurements.footType}
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    showCustomizationSection();
                }, 2000);
                
            } catch (error) {
                console.error('Scan error:', error);
                scanResults.innerHTML = `
                    <div class="api-status error">
                        Scan failed: ${error.message || 'Unknown error'}
                    </div>
                    <button class="btn btn-primary" onclick="startDemoScan()">Use Demo Data</button>
                `;
            } finally {
                scanButton.disabled = false;
                scanButton.textContent = 'Start 3D Scan';
            }
        }

        // Start demo scan without camera
        function startDemoScan() {
            const measurements = {
                length: "26.5",
                width: "10.2",
                height: "6.8",
                archHeight: "3.1",
                footType: "Normal"
            };
            
            footMeasurements = measurements;
            
            const scanResults = document.getElementById('scan-results');
            scanResults.classList.remove('hidden');
            scanResults.innerHTML = `
                <div style="text-align: center; color: var(--secondary);">
                    <h3>✅ Demo Measurements Loaded!</h3>
                    <p>Using sample foot measurements</p>
                    <div style="margin-top: 1rem;">
                        <strong>Length:</strong> ${measurements.length}cm<br>
                        <strong>Width:</strong> ${measurements.width}cm<br>
                        <strong>Height:</strong> ${measurements.height}cm<br>
                        <strong>Arch Height:</strong> ${measurements.archHeight}cm<br>
                        <strong>Foot Type:</strong> ${measurements.footType}
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                showCustomizationSection();
            }, 1500);
        }

        // Show customization section
        function showCustomizationSection() {
            try {
                document.getElementById('scan-section').style.display = 'none';
                document.getElementById('customization-section').style.display = 'block';
                document.getElementById('final-section').style.display = 'none';
                
                // Initialize 3D scene
                setTimeout(() => {
                    init3DScene();
                }, 100);
            } catch (error) {
                console.error("Failed to show customization section:", error);
                showErrorScreen("Navigation Error", "Failed to load customization section");
            }
        }

        // Initialize 3D scene
        function init3DScene() {
            try {
                const canvas = document.getElementById('shoe-canvas');
                if (!canvas) throw new Error('Canvas element not found');
                
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                
                // Scene setup
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf5f5f5);
                
                // Camera setup
                camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                camera.position.set(3, 2, 3);
                camera.lookAt(0, 0, 0);
                
                // Renderer setup
                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas, 
                    antialias: true,
                    powerPreference: "high-performance"
                });
                renderer.setSize(width, height);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 5, 5);
                directionalLight.castShadow = true;
                directionalLight.shadow.mapSize.width = 2048;
                directionalLight.shadow.mapSize.height = 2048;
                scene.add(directionalLight);
                
                // Add ground plane
                const groundGeometry = new THREE.PlaneGeometry(10, 10);
                const groundMaterial = new THREE.MeshLambertMaterial({ color: 0xffffff });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -0.5;
                ground.receiveShadow = true;
                scene.add(ground);
                
                // Create initial shoe model
                createShoeModel();
                
                // Setup controls
                setupControls();
                
                // Start animation loop
                animate();
            } catch (error) {
                console.error("3D Scene initialization failed:", error);
                document.getElementById('customization-section').innerHTML = `
                    <div class="api-status error">
                        3D Visualization Error: ${error.message || 'Failed to initialize 3D view'}
                    </div>
                    <button class="btn btn-secondary" onclick="location.reload()">Try Again</button>
                `;
            }
        }

        // Create shoe model based on current settings
        function createShoeModel() {
            try {
                // Remove existing model
                if (shoeModel) {
                    scene.remove(shoeModel);
                }
                
                const style = document.getElementById('shoe-style').value;
                shoeModel = createShoeGeometry(style);
                shoeModel.castShadow = true;
                scene.add(shoeModel);
                
                // Update colors immediately
                updateShoeColor();
            } catch (error) {
                console.error("Failed to create shoe model:", error);
            }
        }

        // Create shoe geometry based on style
        function createShoeGeometry(style) {
            try {
                const group = new THREE.Group();
                const primaryColor = document.getElementById('shoe-color').value;
                const accentColor = document.getElementById('accent-color').value;
                const materialType = document.getElementById('shoe-material').value;
                
                // Common material properties based on selected material
                const materialProps = {
                    leather: { roughness: 0.3, metalness: 0.1 },
                    knit: { roughness: 0.8, metalness: 0 },
                    mesh: { roughness: 0.6, metalness: 0 },
                    suede: { roughness: 0.9, metalness: 0 },
                    canvas: { roughness: 0.7, metalness: 0 }
                };
                
                const currentMaterial = materialProps[materialType] || materialProps.leather;
                
                switch (style) {
                    case 'sneaker':
                        return createSneakerGeometry(primaryColor, accentColor, currentMaterial);
                    case 'runner':
                        return createRunnerGeometry(primaryColor, accentColor, currentMaterial);
                    case 'dress':
                        return createDressShoeGeometry(primaryColor, accentColor, currentMaterial);
                    case 'boot':
                        return createBootGeometry(primaryColor, accentColor, currentMaterial);
                    case 'loafer':
                        return createLoaferGeometry(primaryColor, accentColor, currentMaterial);
                    default:
                        return createSneakerGeometry(primaryColor, accentColor, currentMaterial);
                }
            } catch (error) {
                console.error("Failed to create shoe geometry:", error);
                return new THREE.Group(); // Return empty group as fallback
            }
        }

        // Create sneaker geometry
        function createSneakerGeometry(primaryColor, accentColor, materialProps) {
            const group = new THREE.Group();
            
            // Main shoe body
            const bodyGeometry = new THREE.CapsuleGeometry(0.4, 2, 4, 8);
            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: primaryColor,
                ...materialProps
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.z = Math.PI / 2;
            body.position.y = 0.4;
            body.castShadow = true;
            group.add(body);
            
            // Sole
            const soleGeometry = new THREE.CylinderGeometry(0.6, 0.7, 0.3, 16);
            const soleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x333333,
                roughness: 0.8
            });
            const sole = new THREE.Mesh(soleGeometry, soleMaterial);
            sole.position.y = 0.15;
            sole.castShadow = true;
            group.add(sole);
            
            // Toe cap
            const toeCapGeometry = new THREE.SphereGeometry(0.4, 16, 8, 0, Math.PI);
            const toeCapMaterial = new THREE.MeshStandardMaterial({ 
                color: accentColor,
                roughness: 0.4
            });
            const toeCap = new THREE.Mesh(toeCapGeometry, toeCapMaterial);
            toeCap.position.set(1, 0.4, 0);
            toeCap.rotation.z = Math.PI / 2;
            toeCap.castShadow = true;
            group.add(toeCap);
            
            // Laces
            for (let i = 0; i < 6; i++) {
                const laceGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.4);
                const laceMaterial = new THREE.MeshStandardMaterial({ color: 0x654321 });
                const lace = new THREE.Mesh(laceGeometry, laceMaterial);
                lace.position.set(0.2 - i * 0.2, 0.7, 0);
                lace.rotation.z = Math.PI / 2;
                group.add(lace);
            }
            
            return group;
        }

        // Create runner geometry
        function createRunnerGeometry(primaryColor, accentColor, materialProps) {
            const group = new THREE.Group();
            
            // Streamlined body
            const bodyGeometry = new THREE.CapsuleGeometry(0.35, 2.2, 4, 12);
            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: primaryColor,
                ...materialProps
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.z = Math.PI / 2;
            body.position.y = 0.35;
            body.castShadow = true;
            group.add(body);
            
            // Performance sole
            const soleGeometry = new THREE.CylinderGeometry(0.55, 0.65, 0.4, 20);
            const soleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                roughness: 0.9
            });
            const sole = new THREE.Mesh(soleGeometry, soleMaterial);
            sole.position.y = 0.2;
            sole.castShadow = true;
            group.add(sole);
            
            // Accent stripes
            for (let i = 0; i < 3; i++) {
                const stripeGeometry = new THREE.BoxGeometry(0.1, 0.05, 1.8);
                const stripeMaterial = new THREE.MeshStandardMaterial({ color: accentColor });
                const stripe = new THREE.Mesh(stripeGeometry, stripeMaterial);
                stripe.position.set(0, 0.5 + i * 0.1, 0);
                group.add(stripe);
            }
            
            return group;
        }

        // Create dress shoe geometry
        function createDressShoeGeometry(primaryColor, accentColor, materialProps) {
            const group = new THREE.Group();
            
            // Elegant body
            const bodyGeometry = new THREE.CapsuleGeometry(0.38, 1.8, 4, 10);
            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: primaryColor,
                ...materialProps
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.z = Math.PI / 2;
            body.position.y = 0.38;
            body.castShadow = true;
            group.add(body);
            
            // Formal sole
            const soleGeometry = new THREE.CylinderGeometry(0.5, 0.52, 0.15, 16);
            const soleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2d1810,
                roughness: 0.6,
                metalness: 0.1
            });
            const sole = new THREE.Mesh(soleGeometry, soleMaterial);
            sole.position.y = 0.075;
            sole.castShadow = true;
            group.add(sole);
            
            // Heel
            const heelGeometry = new THREE.CylinderGeometry(0.3, 0.35, 0.4, 8);
            const heelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2d1810,
                roughness: 0.6
            });
            const heel = new THREE.Mesh(heelGeometry, heelMaterial);
            heel.position.set(-0.7, 0.2, 0);
            heel.castShadow = true;
            group.add(heel);
            
            return group;
        }

        // Create boot geometry
        function createBootGeometry(primaryColor, accentColor, materialProps) {
            const group = new THREE.Group();
            
            // Boot body
            const bodyGeometry = new THREE.CapsuleGeometry(0.42, 1.9, 4, 8);
            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: primaryColor,
                ...materialProps
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.z = Math.PI / 2;
            body.position.y = 0.42;
            body.castShadow = true;
            group.add(body);
            
            // Boot ankle
            const ankleGeometry = new THREE.CylinderGeometry(0.45, 0.42, 0.8, 8);
            const ankleMaterial = new THREE.MeshStandardMaterial({ 
                color: primaryColor,
                ...materialProps
            });
            const ankle = new THREE.Mesh(ankleGeometry, ankleMaterial);
            ankle.position.y = 0.82;
            ankle.castShadow = true;
            group.add(ankle);
            
            // Sole
            const soleGeometry = new THREE.CylinderGeometry(0.58, 0.62, 0.25, 12);
            const soleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x3d2914,
                roughness: 0.8
            });
            const sole = new THREE.Mesh(soleGeometry, soleMaterial);
            sole.position.y = 0.125;
            sole.castShadow = true;
            group.add(sole);
            
            // Laces
            for (let i = 0; i < 8; i++) {
                const laceGeometry = new THREE.CylinderGeometry(0.02, 0.02, 0.45);
                const laceMaterial = new THREE.MeshStandardMaterial({ color: accentColor });
                const lace = new THREE.Mesh(laceGeometry, laceMaterial);
                lace.position.set(0.3 - i * 0.15, 0.6 + i * 0.1, 0);
                lace.rotation.z = Math.PI / 2;
                group.add(lace);
            }
            
            return group;
        }

        // Create loafer geometry
        function createLoaferGeometry(primaryColor, accentColor, materialProps) {
            const group = new THREE.Group();
            
            // Loafer body
            const bodyGeometry = new THREE.CapsuleGeometry(0.36, 1.85, 4, 10);
            const bodyMaterial = new THREE.MeshStandardMaterial({ 
                color: primaryColor,
                ...materialProps
            });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.rotation.z = Math.PI / 2;
            body.position.y = 0.36;
            body.castShadow = true;
            group.add(body);
            
            // Sole
            const soleGeometry = new THREE.CylinderGeometry(0.52, 0.54, 0.18, 16);
            const soleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2d1810,
                roughness: 0.7
            });
            const sole = new THREE.Mesh(soleGeometry, soleMaterial);
            sole.position.y = 0.09;
            sole.castShadow = true;
            group.add(sole);
            
            // Decorative strap
            const strapGeometry = new THREE.BoxGeometry(1.2, 0.08, 0.4);
            const strapMaterial = new THREE.MeshStandardMaterial({ 
                color: accentColor,
                roughness: 0.4
            });
            const strap = new THREE.Mesh(strapGeometry, strapMaterial);
            strap.position.set(0.2, 0.52, 0);
            group.add(strap);
            
            return group;
        }

        // Setup model controls
        function setupControls() {
            try {
                document.getElementById('rotate-left').addEventListener('click', () => {
                    currentRotation -= 0.3;
                    updateModelRotation();
                });
                
                document.getElementById('rotate-right').addEventListener('click', () => {
                    currentRotation += 0.3;
                    updateModelRotation();
                });
                
                document.getElementById('reset-view').addEventListener('click', () => {
                    currentRotation = 0;
                    camera.position.set(3, 2, 3);
                    camera.lookAt(0, 0, 0);
                    updateModelRotation();
                });
            } catch (error) {
                console.error("Failed to setup controls:", error);
            }
        }

        // Update model rotation
        function updateModelRotation() {
            if (shoeModel) {
                shoeModel.rotation.y = currentRotation;
            }
        }

        // Animation loop
        function animate() {
            try {
                animationId = requestAnimationFrame(animate);
                
                // Gentle rotation
                if (shoeModel) {
                    shoeModel.rotation.y += rotationSpeed;
                }
                
                renderer.render(scene, camera);
            } catch (error) {
                console.error("Animation error:", error);
                cancelAnimationFrame(animationId);
            }
        }

        // Update shoe model when customization changes
        function updateShoeModel() {
            try {
                createShoeModel();
                updateShoeColor();
            } catch (error) {
                console.error("Failed to update shoe model:", error);
            }
        }

        // Update shoe colors
        function updateShoeColor() {
            if (!shoeModel) return;
            
            try {
                const primaryColor = document.getElementById('shoe-color').value;
                const accentColor = document.getElementById('accent-color').value;
                
                shoeModel.traverse((child) => {
                    if (child.isMesh && child.material) {
                        // Update primary color for main body parts
                        if (child.geometry.type === 'CapsuleGeometry' || 
                            child.geometry.type === 'CylinderGeometry') {
                            child.material.color.setHex(primaryColor.replace('#', '0x'));
                        }
                        // Update accent colors for details
                        if (child.geometry.type === 'SphereGeometry' || 
                            child.geometry.type === 'BoxGeometry') {
                            child.material.color.setHex(accentColor.replace('#', '0x'));
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to update shoe colors:", error);
            }
        }

        // Show final section
        function showFinalSection() {
            try {
                document.getElementById('customization-section').style.display = 'none';
                document.getElementById('final-section').style.display = 'block';
                
                updateDesignSpecs();
                
                // Initialize final 3D scene
                setTimeout(() => {
                    initFinal3DScene();
                }, 100);
            } catch (error) {
                console.error("Failed to show final section:", error);
                showErrorScreen("Navigation Error", "Failed to load final preview");
            }
        }

        // Initialize final 3D scene
        function initFinal3DScene() {
            try {
                const canvas = document.getElementById('final-shoe-canvas');
                if (!canvas) throw new Error('Final canvas element not found');
                
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                
                // Final scene setup
                finalScene = new THREE.Scene();
                finalScene.background = new THREE.Color(0xf8f9fa);
                
                // Final camera setup
                finalCamera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
                finalCamera.position.set(4, 3, 4);
                finalCamera.lookAt(0, 0, 0);
                
                // Final renderer setup
                finalRenderer = new THREE.WebGLRenderer({ 
                    canvas: canvas, 
                    antialias: true,
                    powerPreference: "high-performance"
                });
                finalRenderer.setSize(width, height);
                finalRenderer.shadowMap.enabled = true;
                finalRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Enhanced lighting for final view
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                finalScene.add(ambientLight);
                
                const spotLight = new THREE.SpotLight(0xffffff, 1.2);
                spotLight.position.set(10, 10, 10);
                spotLight.castShadow = true;
                spotLight.shadow.mapSize.width = 4096;
                spotLight.shadow.mapSize.height = 4096;
                finalScene.add(spotLight);
                
                const rimLight = new THREE.DirectionalLight(0xffffff, 0.5);
                rimLight.position.set(-5, 5, -5);
                finalScene.add(rimLight);
                
                // Add elegant ground
                const groundGeometry = new THREE.PlaneGeometry(15, 15);
                const groundMaterial = new THREE.MeshLambertMaterial({ 
                    color: 0xffffff,
                    transparent: true,
                    opacity: 0.8
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.position.y = -0.5;
                ground.receiveShadow = true;
                finalScene.add(ground);
                
                // Create final shoe model
                const finalShoe = createShoeGeometry(document.getElementById('shoe-style').value);
                finalShoe.castShadow = true;
                finalShoe.scale.set(1.2, 1.2, 1.2); // Slightly larger for final view
                finalScene.add(finalShoe);
                
                // Animate final scene
                function animateFinal() {
                    try {
                        requestAnimationFrame(animateFinal);
                        finalShoe.rotation.y += 0.01;
                        finalRenderer.render(finalScene, finalCamera);
                    } catch (error) {
                        console.error("Final animation error:", error);
                    }
                }
                animateFinal();
            } catch (error) {
                console.error("Final 3D scene initialization failed:", error);
                document.getElementById('final-section').innerHTML = `
                    <div class="api-status error">
                        Final Preview Error: ${error.message || 'Failed to initialize final preview'}
                    </div>
                    <button class="btn btn-secondary" onclick="showCustomizationSection()">Back to Customization</button>
                `;
            }
        }

        // Update design specifications
        function updateDesignSpecs() {
            try {
                const style = document.getElementById('shoe-style').value;
                const material = document.getElementById('shoe-material').value;
                const sole = document.getElementById('sole-type').value;
                const primaryColor = document.getElementById('shoe-color').value;
                const accentColor = document.getElementById('accent-color').value;
                
                const specsHtml = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <p><strong>Style:</strong> ${style.charAt(0).toUpperCase() + style.slice(1)}</p>
                        <p><strong>Material:</strong> ${material.charAt(0).toUpperCase() + material.slice(1)}</p>
                        <p><strong>Sole:</strong> ${sole.charAt(0).toUpperCase() + sole.slice(1)}</p>
                        <p><strong>Primary Color:</strong> <span style="display: inline-block; width: 20px; height: 20px; background: ${primaryColor}; border-radius: 50%; margin-left: 5px; vertical-align: middle;"></span></p>
                        <p><strong>Accent Color:</strong> <span style="display: inline-block; width: 20px; height: 20px; background: ${accentColor}; border-radius: 50%; margin-left: 5px; vertical-align: middle;"></span></p>
                        ${footMeasurements ? `
                            <hr style="margin: 0.5rem 0;">
                            <p><strong>Custom Fit:</strong></p>
                            <p>Length: ${footMeasurements.length}cm</p>
                            <p>Width: ${footMeasurements.width}cm</p>
                            <p>Height: ${footMeasurements.height}cm</p>
                            <p>Arch Height: ${footMeasurements.archHeight}cm</p>
                            <p>Foot Type: ${footMeasurements.footType}</p>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('design-specs').innerHTML = specsHtml;
            } catch (error) {
                console.error("Failed to update design specs:", error);
                document.getElementById('design-specs').innerHTML = `
                    <div class="api-status error">
                        Failed to load design specifications
                    </div>
                `;
            }
        }

        // Place order
        function placeOrder() {
            const orderButton = document.getElementById('place-order');
            
            try {
                const orderData = {
                    measurements: footMeasurements,
                    design: {
                        style: document.getElementById('shoe-style').value,
                        material: document.getElementById('shoe-material').value,
                        sole: document.getElementById('sole-type').value,
                        primaryColor: document.getElementById('shoe-color').value,
                        accentColor: document.getElementById('accent-color').value
                    },
                    timestamp: new Date().toISOString()
                };
                
                // Validate order data
                if (!orderData.measurements) {
                    throw new Error('Missing foot measurements');
                }
                
                // Simulate order placement
                orderButton.disabled = true;
                orderButton.textContent = 'Processing Order...';
                
                setTimeout(() => {
                    alert(`Order placed successfully! 
                    
    Order ID: ST-${Date.now()}
    Estimated delivery: 2-3 weeks
    Total: $299.00

    You will receive an email confirmation shortly.`);
                    
                    orderButton.disabled = false;
                    orderButton.textContent = 'Place Order';
                    
                    // Reset to beginning
                    setTimeout(() => {
                        resetApplication();
                    }, 2000);
                }, 2000);
            } catch (error) {
                console.error("Order placement failed:", error);
                alert(`Order failed: ${error.message || 'Unknown error'}`);
                orderButton.disabled = false;
                orderButton.textContent = 'Place Order';
            }
        }

        // Reset application to initial state
        function resetApplication() {
            try {
                document.getElementById('final-section').style.display = 'none';
                document.getElementById('scan-section').style.display = 'block';
                
                // Clean up 3D scenes
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (renderer) {
                    renderer.dispose();
                }
                if (finalRenderer) {
                    finalRenderer.dispose();
                }
                
                // Reset form
                document.getElementById('shoe-style').value = 'sneaker';
                document.getElementById('shoe-color').value = '#2563eb';
                document.getElementById('accent-color').value = '#ffffff';
                document.getElementById('shoe-material').value = 'leather';
                document.getElementById('sole-type').value = 'standard';
                
                footMeasurements = null;
                
                // Reset scan results
                document.getElementById('scan-results').classList.add('hidden');
                document.getElementById('scan-results').innerHTML = `
                    <div class="spinner"></div>
                    <p style="text-align: center;">Processing 3D foot scan...</p>
                `;
                
                // Reinitialize camera
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }
                initCamera();
            } catch (error) {
                console.error("Failed to reset application:", error);
                showErrorScreen("Reset Error", "Failed to reset application");
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            try {
                if (camera && renderer) {
                    const canvas = document.getElementById('shoe-canvas');
                    const width = canvas.clientWidth;
                    const height = canvas.clientHeight;
                    
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                }
                
                if (finalCamera && finalRenderer) {
                    const canvas = document.getElementById('final-shoe-canvas');
                    const width = canvas.clientWidth;
                    const height = canvas.clientHeight;
                    
                    finalCamera.aspect = width / height;
                    finalCamera.updateProjectionMatrix();
                    finalRenderer.setSize(width, height);
                }
            } catch (error) {
                console.error("Resize handler error:", error);
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            try {
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                if (renderer) {
                    renderer.dispose();
                }
                if (finalRenderer) {
                    finalRenderer.dispose();
                }
            } catch (error) {
                console.error("Cleanup error:", error);
            }
        });
    </script>
</body>
</html>
