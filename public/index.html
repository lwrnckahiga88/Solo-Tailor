<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoloTailor AI - Professional 3D Footwear Customization</title>
    <!-- 3DLook SDK -->
    <script src="https://sdk.3dlook.com/v1.2/3dlook-sdk.js"></script>
    <!-- Three.js for 3D rendering -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
    <!-- FingerprintJS for device identification -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <style>
        :root {
            --primary: #6d28d9;
            --primary-light: #8b5cf6;
            --secondary: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #94a3b8;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .user-profile {
            position: absolute;
            right: 0;
            top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        header h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        /* Scanning Section */
        .scan-section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
        }

        .scan-tips {
            position: absolute;
            right: 2rem;
            top: 2rem;
            background-color: var(--primary-light);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
        }

        .scan-tips-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
            width: 300px;
        }

        .scan-tips:hover .scan-tips-content {
            display: block;
        }

        .scan-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        #camera-feed {
            width: 100%;
            border-radius: 0.5rem;
            display: block;
            aspect-ratio: 4/3;
            background: #000;
        }

        .scan-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .foot-outline {
            width: 60%;
            height: 70%;
            border: 3px dashed var(--primary);
            border-radius: 20% 20% 50% 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { border-color: var(--primary); }
            50% { border-color: var(--primary-light); }
            100% { border-color: var(--primary); }
        }

        .scan-instructions {
            text-align: center;
            margin: 1rem 0;
        }

        /* Customization Section */
        .customization-section {
            display: none;
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .customizer-container {
            display: flex;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .customizer-container {
                flex-direction: column;
            }
        }

        .visualization-panel {
            flex: 2;
            position: relative;
        }

        #shoe-canvas {
            width: 100%;
            height: 500px;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .customization-panel {
            flex: 1;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        /* Final Product Section */
        .final-section {
            display: none;
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .final-view-container {
            display: flex;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .final-view-container {
                flex-direction: column;
            }
        }

        #final-shoe-canvas {
            flex: 1;
            height: 500px;
            background: #f8fafc;
            border-radius: 0.5rem;
        }

        .final-details {
            flex: 1;
        }

        /* Common styles */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-light);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .hidden {
            display: none;
        }

        /* Loading states */
        .spinner {
            width: 40px;
            height: 40px;
            margin: 2rem auto;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Model Controls */
        .model-controls {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            z-index: 10;
            display: flex;
            gap: 0.5rem;
        }

        .model-controls button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            background-color: #e0e7ff;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--primary);
            border-radius: 0.5rem;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Notification system */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: var(--secondary);
        }

        .notification.error {
            background-color: var(--error);
        }

        .notification.warning {
            background-color: var(--warning);
        }

        /* Size recommendation */
        .size-recommendation {
            background-color: #f0fdf4;
            border-left: 4px solid var(--secondary);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .app-container {
                padding: 1rem;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .scan-section, .customization-section, .final-section {
                padding: 1rem;
            }
        }

        /* Animation for shoe display */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .floating {
            animation: float 3s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div class="user-profile">
                <span id="user-name">Guest</span>
                <div class="profile-avatar" id="user-avatar">G</div>
            </div>
            <h1>SoloTailor AI</h1>
            <p>Professional 3D Footwear Customization</p>
        </header>

        <!-- Scanning Section -->
        <section class="scan-section" id="scan-section">
            <div class="scan-tips">
                Scanning Tips
                <div class="scan-tips-content">
                    <h4>For Best Results:</h4>
                    <ul>
                        <li>Stand on a flat, well-lit surface</li>
                        <li>Wear form-fitting socks or bare feet</li>
                        <li>Keep your foot within the outline</li>
                        <li>Hold still during scanning</li>
                        <li>Scan both feet for complete sizing</li>
                    </ul>
                </div>
            </div>
            
            <h2>1. 3D Foot Scanning</h2>
            <div class="scan-container">
                <video id="camera-feed" autoplay playsinline></video>
                <div class="scan-overlay">
                    <div class="foot-outline"></div>
                </div>
            </div>
            <div class="scan-instructions">
                <p>Position your foot within the outline and hold still</p>
                <button id="start-scan" class="btn btn-primary">Start 3D Scan</button>
                <button id="scan-left-foot" class="btn btn-secondary hidden">Scan Left Foot</button>
                <button id="scan-right-foot" class="btn btn-secondary hidden">Scan Right Foot</button>
            </div>
            
            <div id="scan-results" class="hidden">
                <div class="progress-container">
                    <div id="scan-progress" class="progress-bar"></div>
                </div>
                <p style="text-align: center;">Creating your 3D foot model...</p>
            </div>
        </section>

        <!-- Customization Section -->
        <section class="customization-section" id="customization-section">
            <h2>2. Design Your Shoe</h2>
            <div class="customizer-container">
                <div class="visualization-panel">
                    <canvas id="shoe-canvas"></canvas>
                    <div class="model-controls">
                        <button id="rotate-left" title="Rotate Left">↩</button>
                        <button id="rotate-right" title="Rotate Right">↪</button>
                        <button id="reset-view" title="Reset View">⟲</button>
                        <button id="toggle-animation" title="Toggle Animation">⏯</button>
                    </div>
                </div>
                
                <div class="customization-panel">
                    <div class="size-recommendation" id="size-recommendation">
                        <h4>Recommended Size</h4>
                        <p>Based on your scan: <strong id="recommended-size">US 9 / EU 42</strong></p>
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-style">Style</label>
                        <select id="shoe-style" class="form-control">
                            <option value="sneaker">Sneaker</option>
                            <option value="runner">Running Shoe</option>
                            <option value="dress">Dress Shoe</option>
                            <option value="boot">Boot</option>
                            <option value="sandals">Sandals</option>
                            <option value="custom">Custom Design</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-color">Color</label>
                        <input type="color" id="shoe-color" value="#333333" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-material">Material</label>
                        <select id="shoe-material" class="form-control">
                            <option value="leather">Leather</option>
                            <option value="knit">Knit</option>
                            <option value="mesh">Mesh</option>
                            <option value="suede">Suede</option>
                            <option value="vegan">Vegan Leather</option>
                            <option value="recycled">Recycled Materials</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-size">Size</label>
                        <select id="shoe-size" class="form-control">
                            <!-- Filled dynamically based on recommendation -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="shoe-width">Width</label>
                        <select id="shoe-width" class="form-control">
                            <option value="narrow">Narrow</option>
                            <option value="standard" selected>Standard</option>
                            <option value="wide">Wide</option>
                            <option value="extra-wide">Extra Wide</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="custom-text">Custom Text (max 15 chars)</label>
                        <input type="text" id="custom-text" maxlength="15" class="form-control" placeholder="Optional personalization">
                    </div>
                    
                    <button id="view-final" class="btn btn-primary">View Final Design</button>
                    <button id="save-design" class="btn btn-secondary">Save Design</button>
                </div>
            </div>
        </section>

        <!-- Final Product Section -->
        <section class="final-section" id="final-section">
            <h2>3. Your Custom Shoe</h2>
            <div class="final-view-container">
                <canvas id="final-shoe-canvas"></canvas>
                <div class="final-details">
                    <h3>Design Specifications</h3>
                    <div id="design-specs" style="margin-bottom: 1.5rem;">
                        <!-- Filled by JavaScript -->
                    </div>
                    <div id="foot-measurements" style="margin-bottom: 1.5rem;">
                        <!-- Filled by JavaScript -->
                    </div>
                    <div class="form-group">
                        <label for="customer-notes">Special Instructions</label>
                        <textarea id="customer-notes" class="form-control" rows="3" placeholder="Any special requests for your order"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="delivery-option">Delivery Option</label>
                        <select id="delivery-option" class="form-control">
                            <option value="standard">Standard (5-7 business days)</option>
                            <option value="express">Express (2-3 business days)</option>
                            <option value="priority">Priority (1 business day)</option>
                        </select>
                    </div>
                    <button id="place-order" class="btn btn-primary">Place Order</button>
                    <button id="back-to-edit" class="btn btn-secondary">Edit Design</button>
                    <button id="share-design" class="btn btn-secondary">Share Design</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Notification container -->
    <div id="notification-container"></div>

    <script>
        // Global variables
        let mediaStream;
        let scene, camera, renderer, shoeModel, controls;
        let finalScene, finalCamera, finalRenderer, finalControls;
        let currentRotation = 0;
        const rotationSpeed = 0.02;
        const loader = new THREE.GLTFLoader();
        let footScanData = null;
        let look3DSDK = null;
        let isAnimating = false;
        let animationId = null;
        let userProfile = {
            name: "Guest",
            initials: "G",
            sessionId: null,
            savedDesigns: []
        };
        
        // Model paths (replace with your actual Blender-exported GLB files)
        const MODEL_PATHS = {
            sneaker: 'models/sneaker.glb',
            runner: 'models/runner.glb',
            dress: 'models/dress_shoe.glb',
            boot: 'models/boot.glb',
            sandals: 'models/sandals.glb',
            custom: 'models/custom.glb'
        };

        // Size conversion chart
        const SIZE_CHART = {
            us: {
                min: 4,
                max: 15,
                increment: 0.5,
                eu: size => size + 33,
                uk: size => size - 0.5
            },
            eu: {
                min: 35,
                max: 48,
                increment: 1,
                us: size => size - 33,
                uk: size => size - 33 - 0.5
            },
            uk: {
                min: 3,
                max: 14,
                increment: 0.5,
                us: size => size + 0.5,
                eu: size => size + 33 + 0.5
            }
        };

        // 3DLook Foot Scanner Integration
        class FootScanner3DLook {
            constructor() {
                this.initialized = false;
                this.sdk = null;
                this.scanResults = null;
                this.currentFoot = 'right'; // Start with right foot
            }
            
            async init() {
                try {
                    // Initialize 3DLook SDK
                    this.sdk = new window.Look3D({
                        clientId: 'YOUR_3DLOOK_CLIENT_ID', // Replace with your actual client ID
                        environment: 'sandbox', // or 'production' for live
                        scanningType: 'foot'
                    });
                    
                    // Set up event listeners
                    this.setupEventListeners();
                    
                    // Initialize camera
                    await this.initCamera();
                    
                    this.initialized = true;
                    showNotification('3DLook scanner ready', 'success');
                    return true;
                } catch (error) {
                    console.error("3DLook initialization failed:", error);
                    showNotification('Professional scanning unavailable', 'warning');
                    this.showUploadOption();
                    return false;
                }
            }
            
            async initCamera() {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    const videoElement = document.getElementById('camera-feed');
                    videoElement.srcObject = mediaStream;
                    return true;
                } catch (error) {
                    console.error("Camera access error:", error);
                    showNotification('Camera access denied', 'error');
                    return false;
                }
            }
            
            setupEventListeners() {
                this.sdk.on('scanning_started', () => {
                    console.log("3DLook scanning started");
                    document.getElementById('scan-results').classList.remove('hidden');
                    document.getElementById('start-scan').classList.add('hidden');
                    document.getElementById(`scan-${this.currentFoot}-foot`).classList.add('hidden');
                    showNotification(`Scanning ${this.currentFoot} foot`, 'success');
                });
                
                this.sdk.on('scanning_progress', (progress) => {
                    console.log(`Scanning progress: ${progress}%`);
                    document.getElementById('scan-progress').style.width = `${progress}%`;
                });
                
                this.sdk.on('scanning_completed', (results) => {
                    console.log("Scanning completed", results);
                    this.scanResults = results;
                    this.processScanResults();
                    
                    // Check if we need to scan the other foot
                    if (this.currentFoot === 'right') {
                        this.currentFoot = 'left';
                        document.getElementById('scan-left-foot').classList.remove('hidden');
                        showNotification('Now scan your left foot', 'success');
                    } else {
                        showNotification('Both feet scanned successfully!', 'success');
                    }
                });
                
                this.sdk.on('error', (error) => {
                    console.error("3DLook scanning error:", error);
                    showNotification(`Scanning error: ${error.message}`, 'error');
                    this.resetScanUI();
                });
            }
            
            async startScan() {
                if (!this.initialized) {
                    throw new Error("3DLook scanner not initialized");
                }
                
                try {
                    // Start the scanning process
                    await this.sdk.startScanning({
                        containerId: 'camera-feed',
                        overlayId: 'foot-outline',
                        instructions: {
                            positioning: "Position your foot within the outline",
                            scanning: "Hold still while we scan your foot"
                        },
                        foot: this.currentFoot
                    });
                } catch (error) {
                    console.error("Failed to start scanning:", error);
                    showNotification('Failed to start scanning', 'error');
                    this.showUploadOption();
                    throw error;
                }
            }
            
            processScanResults() {
                // Extract measurements from 3DLook results
                const measurements = this.scanResults.measurements || {};
                footScanData = footScanData || {};
                
                footScanData[this.currentFoot] = {
                    length: measurements.footLength?.value || 0,
                    width: measurements.footWidth?.value || 0,
                    archHeight: measurements.archHeight?.value || 0,
                    timestamp: new Date().toISOString(),
                    modelData: this.scanResults.model // 3D model data if available
                };
                
                // Calculate average if both feet scanned
                if (footScanData.left && footScanData.right) {
                    footScanData.average = {
                        length: (footScanData.left.length + footScanData.right.length) / 2,
                        width: (footScanData.left.width + footScanData.right.width) / 2,
                        archHeight: (footScanData.left.archHeight + footScanData.right.archHeight) / 2
                    };
                    
                    this.displayFootMeasurements();
                    this.calculateSizeRecommendation();
                    this.completeScan();
                } else {
                    this.displayScanInstructions();
                }
            }
            
            displayScanInstructions() {
                document.getElementById('scan-instructions').innerHTML = `
                    <p>${this.currentFoot === 'left' ? 'Left' : 'Right'} foot scanned successfully</p>
                    <button id="scan-${this.currentFoot}-foot" class="btn btn-primary">
                        Scan ${this.currentFoot === 'left' ? 'Right' : 'Left'} Foot
                    </button>
                `;
                
                document.getElementById(`scan-${this.currentFoot}-foot`).addEventListener('click', () => {
                    this.startScan();
                });
            }
            
            displayFootMeasurements() {
                if (footScanData.average) {
                    document.getElementById('foot-measurements').innerHTML = `
                        <h4>Your Foot Measurements</h4>
                        <p><strong>Length:</strong> ${footScanData.average.length.toFixed(1)} cm</p>
                        <p><strong>Width:</strong> ${footScanData.average.width.toFixed(1)} cm</p>
                        <p><strong>Arch Height:</strong> ${footScanData.average.archHeight.toFixed(1)} cm</p>
                        <p><em>Based on average of both feet</em></p>
                    `;
                }
            }
            
            calculateSizeRecommendation() {
                if (!footScanData.average) return;
                
                // Simple size calculation (in a real app, use more sophisticated algorithm)
                const footLength = footScanData.average.length;
                const usSize = 3 + (footLength - 22) / 0.847; // Approximate conversion
                const recommendedSize = Math.round(usSize * 2) / 2; // Round to nearest 0.5
                
                const euSize = SIZE_CHART.us.eu(recommendedSize).toFixed(0);
                const ukSize = SIZE_CHART.us.uk(recommendedSize).toFixed(1);
                
                document.getElementById('recommended-size').textContent = 
                    `US ${recommendedSize} / EU ${euSize} / UK ${ukSize}`;
                
                // Populate size dropdown
                const sizeSelect = document.getElementById('shoe-size');
                sizeSelect.innerHTML = '';
                
                for (let size = SIZE_CHART.us.min; size <= SIZE_CHART.us.max; size += SIZE_CHART.us.increment) {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = `US ${size} (EU ${SIZE_CHART.us.eu(size).toFixed(0)})`;
                    if (Math.abs(size - recommendedSize) < 0.3) {
                        option.selected = true;
                        option.textContent += ' - Recommended';
                    }
                    sizeSelect.appendChild(option);
                }
            }
            
            completeScan() {
                document.getElementById('scan-section').classList.add('hidden');
                document.getElementById('customization-section').style.display = 'block';
                initShoeViewer();
            }
            
            resetScanUI() {
                document.getElementById('start-scan').disabled = false;
                document.getElementById('scan-results').classList.add('hidden');
                document.getElementById('scan-progress').style.width = '0%';
            }
            
            showUploadOption() {
                document.querySelector('.scan-instructions').innerHTML = `
                    <p>Alternative scanning method: Please upload photos of your feet</p>
                    <input type="file" id="foot-upload" accept="image/*" multiple style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('foot-upload').click()">
                        Upload Foot Photos
                    </button>
                `;
                
                document.getElementById('foot-upload').addEventListener('change', (e) => {
                    this.processUploadedImages(e.target.files);
                });
            }
            
            async processUploadedImages(files) {
                if (!files || files.length === 0) return;
                
                document.getElementById('scan-results').classList.remove('hidden');
                showNotification('Processing uploaded images', 'success');
                
                // Simulate processing (in real app, you would send to your backend)
                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        const progressBar = document.getElementById('scan-progress');
                        const currentWidth = parseInt(progressBar.style.width) || 0;
                        if (currentWidth >= 100) {
                            clearInterval(interval);
                            resolve();
                        } else {
                            progressBar.style.width = `${currentWidth + 10}%`;
                        }
                    }, 300);
                });
                
                // Generate mock data from uploads
                footScanData = {
                    left: {
                        length: (24 + Math.random() * 4).toFixed(1),
                        width: (9 + Math.random() * 2).toFixed(1),
                        archHeight: (2 + Math.random()).toFixed(1),
                        timestamp: new Date().toISOString()
                    },
                    right: {
                        length: (24 + Math.random() * 4).toFixed(1),
                        width: (9 + Math.random() * 2).toFixed(1),
                        archHeight: (2 + Math.random()).toFixed(1),
                        timestamp: new Date().toISOString()
                    },
                    average: {
                        length: (24 + Math.random() * 4).toFixed(1),
                        width: (9 + Math.random() * 2).toFixed(1),
                        archHeight: (2 + Math.random()).toFixed(1)
                    }
                };
                
                this.displayFootMeasurements();
                this.calculateSizeRecommendation();
                this.completeScan();
            }
        }

        // Initialize 3D shoe viewer with GLTF models
        function initShoeViewer() {
            const canvas = document.getElementById('shoe-canvas');
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf8fafc);
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 5;
            
            // Renderer setup
            renderer = new THREE.WebGLRenderer({ 
                canvas, 
                antialias: true,
                alpha: true
            });
            renderer.setSize(canvas.clientWidth, canvas.height);
            renderer.shadowMap.enabled = true;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Load initial shoe model
            loadShoeModel('sneaker');
            
            // Animation loop
            function animate() {
                animationId = requestAnimationFrame(animate);
                
                if (isAnimating && shoeModel) {
                    shoeModel.rotation.y += 0.005;
                }
                
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }

        // Load GLTF shoe model
        function loadShoeModel(style) {
            if (shoeModel) scene.remove(shoeModel);
            
            // Show loading state
            const canvas = document.getElementById('shoe-canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#6d28d9';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Loading 3D model...', canvas.width/2, canvas.height/2);
            
            // In a real app, you would load the actual model
            // For this example, we'll use a timeout to simulate loading
            setTimeout(() => {
                // Create a simple shoe model based on foot measurements
                createDynamicShoeModel(style);
                
                // Apply current customization
                updateShoeMaterials();
                
                // Add floating animation if enabled
                if (isAnimating) {
                    shoeModel.userData.floatAnimation = true;
                }
            }, 1000);
        }

        // Create a shoe model that adapts to foot measurements
        function createDynamicShoeModel(style) {
            if (!footScanData?.average) {
                footScanData = {
                    average: {
                        length: 26,
                        width: 10,
                        archHeight: 2.5
                    }
                };
            }
            
            // Base dimensions from scan data
            let length = parseFloat(footScanData.average.length) / 10; // Convert cm to Three.js units
            let width = parseFloat(footScanData.average.width) / 10;
            let height = parseFloat(footScanData.average.archHeight) / 5;
            
            // Style adjustments
            switch(style) {
                case 'runner':
                    height *= 1.2;
                    break;
                case 'dress':
                    length *= 0.95;
                    height *= 0.8;
                    break;
                case 'boot':
                    height *= 1.5;
                    break;
                case 'sandals':
                    height *= 0.7;
                    break;
                default: // sneaker
                    height *= 1.1;
            }
            
            // Create shoe geometry
            const shoeGeometry = new THREE.BoxGeometry(length, height, width * 1.3);
            
            // Style-specific shaping
            if (style === 'sneaker' || style === 'runner') {
                // Round the edges for sneakers/runners
                shoeGeometry.computeVertexNormals();
                for (let i = 0; i < shoeGeometry.attributes.position.count; i++) {
                    const x = shoeGeometry.attributes.position.getX(i);
                    const y = shoeGeometry.attributes.position.getY(i);
                    const z = shoeGeometry.attributes.position.getZ(i);
                    
                    // Round the edges
                    const radius = 0.1;
                    if (Math.abs(x) > length/2 - radius && Math.abs(z) > width/2 - radius) {
                        const dx = (Math.abs(x) - (length/2 - radius)) / radius;
                        const dz = (Math.abs(z) - (width/2 - radius)) / radius;
                        const d = Math.sqrt(dx*dx + dz*dz);
                        if (d < 1) {
                            const f = Math.pow(1 - d, 2);
                            shoeGeometry.attributes.position.setY(i, y + f * 0.2);
                        }
                    }
                }
                shoeGeometry.attributes.position.needsUpdate = true;
            }
            
            const color = document.getElementById('shoe-color').value;
            const materialType = document.getElementById('shoe-material').value;
            
            let materialParams = {
                color: new THREE.Color(color),
                roughness: materialType === 'leather' ? 0.4 : 
                          materialType === 'suede' ? 0.9 : 0.2,
                metalness: materialType === 'leather' ? 0.3 : 0
            };
            
            if (materialType === 'mesh') {
                materialParams.transparent = true;
                materialParams.opacity = 0.8;
            }
            
            const shoeMaterial = new THREE.MeshStandardMaterial(materialParams);
            shoeModel = new THREE.Mesh(shoeGeometry, shoeMaterial);
            
            // Position the shoe
            shoeModel.position.y = 0;
            scene.add(shoeModel);
            
            // Add custom text if specified
            addCustomTextToShoe();
        }
        
        function addCustomTextToShoe() {
            const customText = document.getElementById('custom-text').value.trim();
            if (!customText || !shoeModel) return;
            
            // Remove previous text if exists
            if (shoeModel.userData.textMesh) {
                scene.remove(shoeModel.userData.textMesh);
            }
            
            // In a real app, you would use Three.js text geometry
            // For this example, we'll create a simple plane with text texture
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = document.getElementById('shoe-color').value;
            ctx.font = 'Bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(customText, canvas.width/2, canvas.height/2 + 15);
            
            const texture = new THREE.CanvasTexture(canvas);
            const textMaterial = new THREE.MeshBasicMaterial({
                map: texture,
                transparent: true
            });
            
            const textGeometry = new THREE.PlaneGeometry(1, 0.5);
            const textMesh = new THREE.Mesh(textGeometry, textMaterial);
            
            // Position text on the side of the shoe
            textMesh.position.set(0, shoeModel.geometry.parameters.height/2 + 0.01, 0);
            textMesh.rotation.x = -Math.PI / 2;
            textMesh.scale.set(0.5, 0.5, 0.5);
            
            shoeModel.add(textMesh);
            shoeModel.userData.textMesh = textMesh;
        }

        // Update shoe materials based on customization
        function updateShoeMaterials() {
            if (!shoeModel) return;
            
            const color = document.getElementById('shoe-color').value;
            const materialType = document.getElementById('shoe-material').value;
            const customText = document.getElementById('custom-text').value.trim();
            
            shoeModel.traverse(function (child) {
                if (child.isMesh) {
                    // Skip the text mesh
                    if (child === shoeModel.userData.textMesh) return;
                    
                    // Create material based on selection
                    let materialParams = {
                        color: new THREE.Color(color),
                        roughness: materialType === 'leather' ? 0.4 : 
                                  materialType === 'suede' ? 0.9 : 0.2,
                        metalness: materialType === 'leather' ? 0.3 : 0
                    };
                    
                    if (materialType === 'mesh') {
                        materialParams.transparent = true;
                        materialParams.opacity = 0.8;
                    }
                    
                    child.material = new THREE.MeshStandardMaterial(materialParams);
                }
            });
            
            // Update custom text if it exists
            if (customText && shoeModel.userData.textMesh) {
                const canvas = document.createElement('canvas');
                canvas.width = 256;
                canvas.height = 128;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = color;
                ctx.font = 'Bold 40px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(customText, canvas.width/2, canvas.height/2 + 15);
                
                shoeModel.userData.textMesh.material.map.dispose();
                shoeModel.userData.textMesh.material.map = new THREE.CanvasTexture(canvas);
                shoeModel.userData.textMesh.material.needsUpdate = true;
            }
        }

        // Initialize final product viewer
        function initFinalViewer() {
            const canvas = document.getElementById('final-shoe-canvas');
            
            // Scene setup
            finalScene = new THREE.Scene();
            finalScene.background = new THREE.Color(0xf8fafc);
            
            // Camera setup
            finalCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            finalCamera.position.z = 6;
            
            // Renderer setup
            finalRenderer = new THREE.WebGLRenderer({ 
                canvas, 
                antialias: true,
                alpha: true
            });
            finalRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
            finalRenderer.shadowMap.enabled = true;
            
            // Studio lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            finalScene.add(ambientLight);
            
            const keyLight = new THREE.DirectionalLight(0xffffff, 0.8);
            keyLight.position.set(5, 5, 5);
            keyLight.castShadow = true;
            finalScene.add(keyLight);
            
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
            fillLight.position.set(-5, 3, -5);
            finalScene.add(fillLight);
            
            // Clone the current shoe model
            const finalShoe = shoeModel.clone();
            finalScene.add(finalShoe);
            
            // Add environment
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xeeeeee,
                roughness: 0.2,
                metalness: 0
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            finalScene.add(floor);
            
            // Add subtle floating animation
            let floatTime = 0;
            function floatAnimation() {
                floatTime += 0.01;
                finalShoe.position.y = Math.sin(floatTime) * 0.1;
                requestAnimationFrame(floatAnimation);
            }
            floatAnimation();
            
            // Controls
            finalControls = new THREE.OrbitControls(finalCamera, finalRenderer.domElement);
            finalControls.enableDamping = true;
            finalControls.dampingFactor = 0.05;
            
            // Update design specs
            updateDesignSpecs();
            
            // Animation loop
            function animate() {
                requestAnimationFrame(animate);
                finalControls.update();
                finalRenderer.render(finalScene, finalCamera);
            }
            animate();
        }

        // Update design specifications
        function updateDesignSpecs() {
            const style = document.getElementById('shoe-style').options[document.getElementById('shoe-style').selectedIndex].text;
            const material = document.getElementById('shoe-material').options[document.getElementById('shoe-material').selectedIndex].text;
            const color = document.getElementById('shoe-color').value;
            const size = document.getElementById('shoe-size').value;
            const width = document.getElementById('shoe-width').options[document.getElementById('shoe-width').selectedIndex].text;
            const customText = document.getElementById('custom-text').value.trim();
            
            let specsHTML = `
                <h4>Design Specifications</h4>
                <p><strong>Style:</strong> ${style}</p>
                <p><strong>Material:</strong> ${material}</p>
                <p><strong>Color:</strong> <span style="display: inline-block; width: 15px; height: 15px; background: ${color}; border: 1px solid #ddd;"></span> ${color.toUpperCase()}</p>
                <p><strong>Size:</strong> US ${size} (${width} width)</p>
            `;
            
            if (customText) {
                specsHTML += `<p><strong>Custom Text:</strong> "${customText}"</p>`;
            }
            
            document.getElementById('design-specs').innerHTML = specsHTML;
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Hide after 3 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Initialize fingerprint for guest user
        async function initUserSession() {
            try {
                const fpPromise = FingerprintJS.load();
                const fp = await fpPromise;
                const result = await fp.get();
                
                userProfile.sessionId = result.visitorId;
                userProfile.initials = userProfile.sessionId.substring(0, 2).toUpperCase();
                document.getElementById('user-avatar').textContent = userProfile.initials;
            } catch (error) {
                console.error("FingerprintJS failed:", error);
                userProfile.sessionId = 'guest-' + Math.random().toString(36).substring(2, 9);
            }
        }

        // Save current design
        function saveCurrentDesign() {
            const design = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                style: document.getElementById('shoe-style').value,
                color: document.getElementById('shoe-color').value,
                material: document.getElementById('shoe-material').value,
                size: document.getElementById('shoe-size').value,
                width: document.getElementById('shoe-width').value,
                customText: document.getElementById('custom-text').value,
                footData: footScanData
            };
            
            userProfile.savedDesigns.push(design);
            showNotification('Design saved successfully!', 'success');
        }

        // Share current design
        function shareCurrentDesign() {
            const designSpecs = document.getElementById('design-specs').innerText;
            const measurements = document.getElementById('foot-measurements').innerText;
            
            const shareText = `Check out my custom shoe design:\n\n${designSpecs}\n\n${measurements}\n\nCreated with SoloTailor AI`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My Custom Shoe Design',
                    text: shareText,
                    url: window.location.href
                }).catch(err => {
                    console.log('Error sharing:', err);
                    showNotification('Sharing failed', 'error');
                });
            } else {
                // Fallback for browsers without Web Share API
                const shareUrl = `mailto:?subject=My Custom Shoe Design&body=${encodeURIComponent(shareText)}`;
                window.open(shareUrl, '_blank');
                showNotification('Share dialog opened', 'success');
            }
        }

        // Place order
        function placeOrder() {
            const orderBtn = document.getElementById('place-order');
            orderBtn.textContent = 'Processing...';
            orderBtn.disabled = true;
            
            // In a real app, you would send this to your backend
            const orderData = {
                user: userProfile,
                design: {
                    style: document.getElementById('shoe-style').value,
                    color: document.getElementById('shoe-color').value,
                    material: document.getElementById('shoe-material').value,
                    size: document.getElementById('shoe-size').value,
                    width: document.getElementById('shoe-width').value,
                    customText: document.getElementById('custom-text').value,
                    notes: document.getElementById('customer-notes').value,
                    delivery: document.getElementById('delivery-option').value
                },
                measurements: footScanData,
                timestamp: new Date().toISOString()
            };
            
            console.log("Order placed:", orderData);
            
            // Simulate processing
            setTimeout(() => {
                showNotification('Order placed successfully!', 'success');
                orderBtn.textContent = 'Order Placed!';
                
                // In a real app, you would redirect to order confirmation
            }, 2000);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize user session
            await initUserSession();
            
            // Initialize 3DLook foot scanner
            window.footScanner = new FootScanner3DLook();
            await footScanner.init();
            
            // Start scan button
            document.getElementById('start-scan').addEventListener('click', async function() {
                try {
                    this.disabled = true;
                    await footScanner.startScan();
                } catch (error) {
                    console.error("Scan initiation failed:", error);
                    this.disabled = false;
                }
            });
            
            // Left/right foot scan buttons
            document.getElementById('scan-left-foot').addEventListener('click', async function() {
                footScanner.currentFoot = 'left';
                await footScanner.startScan();
            });
            
            document.getElementById('scan-right-foot').addEventListener('click', async function() {
                footScanner.currentFoot = 'right';
                await footScanner.startScan();
            });
            
            // Customization controls
            document.getElementById('shoe-style').addEventListener('change', function() {
                loadShoeModel(this.value);
            });
            
            document.getElementById('shoe-color').addEventListener('input', function() {
                updateShoeMaterials();
                // Update color preview in size recommendation
                document.querySelector('#size-recommendation strong').style.color = this.value;
            });
            
            document.getElementById('shoe-material').addEventListener('change', updateShoeMaterials);
            document.getElementById('custom-text').addEventListener('input', function() {
                addCustomTextToShoe();
                updateDesignSpecs();
            });
            
            // Model controls
            document.getElementById('rotate-left').addEventListener('click', () => {
                currentRotation -= rotationSpeed;
                if (shoeModel) shoeModel.rotation.y = currentRotation;
            });
            
            document.getElementById('rotate-right').addEventListener('click', () => {
                currentRotation += rotationSpeed;
                if (shoeModel) shoeModel.rotation.y = currentRotation;
            });
            
            document.getElementById('reset-view').addEventListener('click', () => {
                controls.reset();
                currentRotation = 0;
                if (shoeModel) shoeModel.rotation.y = 0;
            });
            
            document.getElementById('toggle-animation').addEventListener('click', function() {
                isAnimating = !isAnimating;
                this.textContent = isAnimating ? '⏸' : '⏯';
            });
            
            // View final product button
            document.getElementById('view-final').addEventListener('click', showFinalProduct);
            
            // Back to editing button
            document.getElementById('back-to-edit').addEventListener('click', function() {
                document.getElementById('final-section').style.display = 'none';
                document.getElementById('customization-section').style.display = 'block';
            });
            
            // Save design button
            document.getElementById('save-design').addEventListener('click', saveCurrentDesign);
            
            // Share design button
            document.getElementById('share-design').addEventListener('click', shareCurrentDesign);
            
            // Place order button
            document.getElementById('place-order').addEventListener('click', placeOrder);
        });

        // Clean up when page unloads
        window.addEventListener('beforeunload', function() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>
