<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Keep previous meta tags and styles] -->
    <style>
        /* [Previous CSS remains unchanged] */
    </style>
</head>
<body>
    <!-- [Keep previous HTML structure] -->

    <script>
        // ======================
        // Configuration
        // ======================
        const CONFIG = {
            threeDLookAPIKey: 'your_3dlook_api_key',
            blenderModels: {
                sneaker: '/models/sneaker-optimized.glb',
                runner: '/models/runner-optimized.glb',
                dress: '/models/dress-shoe-optimized.glb',
                boot: '/models/boot-optimized.glb'
            },
            materialPresets: {
                leather: { roughness: 0.4, metalness: 0.3, clearcoat: 0.5 },
                knit: { roughness: 0.8, metalness: 0, sheen: 0.2 },
                mesh: { transparent: true, opacity: 0.9, roughness: 0.7 }
            }
        };

        // ======================
        // Core Application
        // ======================
        class ShoeCustomizer {
            constructor() {
                this.scanner = null;
                this.mediaStream = null;
                this.footData = null;
                this.scene = null;
                this.shoeMesh = null;
                this.init();
            }

            async init() {
                await this.setupCamera();
                this.setupEventListeners();
            }

            // ======================
            // 3D Scanning System
            // ======================
            async setupCamera() {
                try {
                    this.mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                    const video = document.getElementById('camera-feed');
                    video.srcObject = this.mediaStream;
                    
                    video.onloadedmetadata = () => {
                        const isPortrait = window.matchMedia("(orientation: portrait)").matches;
                        video.style.transform = isPortrait ? 
                            'scaleX(-1) rotate(90deg)' : 'scaleX(-1)';
                    };

                    await this.init3DLookScanner();
                } catch (err) {
                    console.error("Camera init failed:", err);
                    this.showFileUploadFallback();
                }
            }

            async init3DLookScanner() {
                try {
                    await this.loadScript('https://sdk.3dlook.me/v2/3dlook-sdk.min.js');
                    
                    if (typeof _3DLOOK !== 'undefined') {
                        this.scanner = new _3DLOOK.Scanner({
                            apiKey: CONFIG.threeDLookAPIKey,
                            scanType: 'foot',
                            container: document.getElementById('camera-feed'),
                            overlay: document.querySelector('.scan-overlay'),
                            scanQuality: 'high'
                        });
                    } else {
                        throw new Error('3DLOOK SDK not loaded');
                    }
                } catch (err) {
                    console.error("Scanner init error:", err);
                    this.showFileUploadFallback();
                }
            }

            // ======================
            // Foot Scanning Logic
            // ======================
            async startScanning() {
                if (!this.scanner) {
                    alert("Scanner not ready. Using file upload.");
                    document.getElementById('foot-upload').click();
                    return;
                }

                this.updateScanUI(true);

                try {
                    const scanResult = await this.scanner.startScan({
                        instructions: 'Position foot in outline',
                        scanDuration: 8000,
                        onProgress: (progress) => {
                            document.getElementById('progress-bar').style.width = `${progress}%`;
                        }
                    });

                    this.footData = await this.scanner.processScan(scanResult);
                    console.log("Foot data:", this.footData);
                    
                    this.processScanComplete();
                } catch (err) {
                    console.error("Scan failed:", err);
                    alert("Scan failed: " + err.message);
                    this.updateScanUI(false);
                }
            }

            processScanComplete() {
                this.updateScanUI(false);
                document.getElementById('scan-results').classList.remove('hidden');
                
                setTimeout(() => {
                    document.getElementById('scan-section').classList.add('hidden');
                    document.getElementById('customization-section').style.display = 'block';
                    this.init3DViewer('shoe-canvas');
                    this.loadShoeModel();
                }, 1500);
            }

            // ======================
            // 3D Shoe Customization
            // ======================
            async loadShoeModel() {
                const style = document.getElementById('shoe-style').value;
                const color = document.getElementById('shoe-color').value;
                const materialType = document.getElementById('shoe-material').value;
                
                this.showLoading('shoe-loading', true);

                try {
                    const loader = new THREE.GLTFLoader();
                    loader.load(CONFIG.blenderModels[style], (gltf) => {
                        this.handleModelLoaded(gltf, color, materialType);
                    }, undefined, (error) => {
                        throw new Error(`Model load failed: ${error.message}`);
                    });
                } catch (err) {
                    this.showError('customization-error', err.message);
                    this.showLoading('shoe-loading', false);
                }
            }

            handleModelLoaded(gltf, color, materialType) {
                if (this.shoeMesh) this.scene.remove(this.shoeMesh);
                
                this.shoeMesh = gltf.scene;
                this.scaleModelToFoot();
                this.applyCustomization(color, materialType);
                
                this.scene.add(this.shoeMesh);
                this.centerModel(this.shoeMesh);
                this.showLoading('shoe-loading', false);
            }

            scaleModelToFoot() {
                if (this.footData?.measurements?.footLength) {
                    const targetLength = this.footData.measurements.footLength / 1000; // mmâ†’meters
                    const bbox = new THREE.Box3().setFromObject(this.shoeMesh);
                    const currentLength = bbox.max.z - bbox.min.z;
                    const scale = targetLength / currentLength;
                    this.shoeMesh.scale.set(scale, scale, scale);
                }
            }

            applyCustomization(color, materialType) {
                this.shoeMesh.traverse((child) => {
                    if (child.isMesh) {
                        // Apply color
                        child.material.color.setHex(parseInt(color.substring(1), 16));
                        
                        // Apply material presets
                        const preset = CONFIG.materialPresets[materialType];
                        Object.assign(child.material, preset);
                        
                        // Special cases
                        if (materialType === 'mesh') {
                            child.material.transparent = true;
                            child.material.opacity = 0.9;
                        }
                    }
                });
            }

            // ======================
            // Manufacturing Outputs
            // ======================
            prepareManufacturingOutput() {
                if (!this.shoeMesh) return null;
                
                // 1. Prepare metrics
                const metrics = {
                    footMeasurements: this.footData?.measurements || {},
                    shoeStyle: document.getElementById('shoe-style').value,
                    material: document.getElementById('shoe-material').value,
                    color: document.getElementById('shoe-color').value,
                    timestamp: new Date().toISOString()
                };
                
                // 2. Export 3D model (simplified for demo)
                const exporter = new THREE.GLTFExporter();
                exporter.parse(this.shoeMesh, (gltf) => {
                    const output = {
                        metrics,
                        modelData: gltf
                    };
                    this.sendToManufacturing(output);
                });
                
                return metrics;
            }

            sendToManufacturing(data) {
                // In production, this would send to your backend
                console.log("Manufacturing data:", data);
                alert(`Order submitted!\nFoot length: ${data.footMeasurements.footLength}mm`);
            }

            // ======================
            // Utility Methods
            // ======================
            init3DViewer(canvasId) {
                const canvas = document.getElementById(canvasId);
                
                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0xf8fafc);
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                this.camera.position.z = 5;
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: canvasId === 'shoe-canvas' ? canvas : undefined,
                    antialias: true,
                    alpha: true
                });
                
                if (canvasId === 'final-shoe-canvas') {
                    canvas.appendChild(this.renderer.domElement);
                }
                
                this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(5, 5, 5);
                this.scene.add(directionalLight);
                
                // Controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                
                // Animation loop
                const animate = () => {
                    requestAnimationFrame(animate);
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                };
                animate();
                
                // Handle resize
                window.addEventListener('resize', () => {
                    this.camera.aspect = canvas.clientWidth / canvas.clientHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                });
            }

            centerModel(model) {
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
                this.controls.reset();
            }

            updateScanUI(scanning) {
                const startBtn = document.getElementById('start-scan');
                startBtn.textContent = scanning ? 'Scanning...' : 'Start Scanning';
                startBtn.disabled = scanning;
                
                document.getElementById('scan-progress').classList.toggle('hidden', !scanning);
                document.getElementById('scanning-animation').classList.toggle('hidden', !scanning);
            }

            showLoading(elementId, show) {
                document.getElementById(elementId).classList.toggle('hidden', !show);
            }

            showError(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.classList.remove('hidden');
            }

            showFileUploadFallback() {
                document.querySelector('.scan-instructions').innerHTML = `
                    <p>Camera access denied. Please upload photos:</p>
                    <input type="file" id="foot-upload" accept="image/*" multiple style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('foot-upload').click()">
                        Upload Foot Photos
                    </button>
                `;
                document.getElementById('foot-upload').addEventListener('change', (e) => this.handleFileUpload(e));
            }

            async handleFileUpload(event) {
                const files = event.target.files;
                if (files.length < 3) {
                    alert("Please upload at least 3 photos");
                    return;
                }

                document.getElementById('scan-results').classList.remove('hidden');
                document.getElementById('start-scan').disabled = true;
                
                // Simulate processing
                this.simulateScanProgress();
                
                setTimeout(() => {
                    // Mock data
                    this.footData = {
                        measurements: {
                            footLength: 265, // mm
                            footWidth: 102,
                            archHeight: 48
                        }
                    };
                    
                    document.getElementById('scan-section').classList.add('hidden');
                    document.getElementById('customization-section').style.display = 'block';
                    this.init3DViewer('shoe-canvas');
                    this.loadShoeModel();
                }, 3000);
            }

            simulateScanProgress() {
                const progressBar = document.getElementById('progress-bar');
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    if (progress >= 100) clearInterval(interval);
                }, 200);
            }

            loadScript(src) {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            setupEventListeners() {
                document.getElementById('start-scan').addEventListener('click', () => this.startScanning());
                document.getElementById('update-shoe').addEventListener('click', () => this.loadShoeModel());
                document.getElementById('view-final').addEventListener('click', () => this.showFinalProduct());
                document.getElementById('back-to-edit').addEventListener('click', () => {
                    document.getElementById('final-section').style.display = 'none';
                    document.getElementById('customization-section').style.display = 'block';
                });
                document.getElementById('place-order').addEventListener('click', () => this.prepareManufacturingOutput());
            }

            cleanup() {
                if (this.mediaStream) this.mediaStream.getTracks().forEach(track => track.stop());
                if (this.scanner) this.scanner.destroy();
            }
        }

        // ======================
        // Initialize Application
        // ======================
        document.addEventListener('DOMContentLoaded', () => {
            const app = new ShoeCustomizer();
            
            // Cleanup on exit
            window.addEventListener('beforeunload', () => app.cleanup());
        });
    </script>
</body>
</html>
